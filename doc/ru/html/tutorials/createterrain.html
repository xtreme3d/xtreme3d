<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Tutorial 15. Creating terrain</title>
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
    <meta charset="windows-1251">
    <meta name="author" content="Gecko">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="text/css" href="../sakura.css" inline>
    <link rel="stylesheet" type="text/css" href="../github.css" inline>
</head>
<body>
<h1 id="15">Урок 15. Создание ландшафта</h1>
<p>Ландшафт (Terrain) является важной составляющей игр многих жанров, моделирующих ситуации реального мира - это гонки, стратегии, многие шутеры и различные игры с открытым миром. Обычно ландшафт не моделируется вручную, а генерируется из так называемой карты высот - изображения, где темные участки означают понижение высоты, а светлые - повышение. Генерирование ландшафта может происходить как в программе 3D-моделирования, так и в самой игре - в последнем случае есть возможность оптимизировать рендеринг ландшафта, динамически изменяя его детализацию в зависимости от удаленности от камеры (динамический LOD). В Xtreme3D также имеется поддержка такой технологии. 
Чтобы отрисовать ландшафт, сначала необходимо загрузить карту высот, в терминологии Xtreme3D - HDS (Height Data Source, источник данных о высоте):</p>
<pre class="gml language-gml"><code class="hljs gml language-gml">hds = BmpHDSCreate(<span class="hljs-string">&quot;heightmap.bmp&quot;</span>);
BmpHDSSetInfiniteWarp(hds, <span class="hljs-number">0</span>);
</code></pre>
<p>Функцией BmpHDSSetInfiniteWarp можно сделать карту высот бесконечно зацикленной во все четыре стороны - очень удобно, если вы хотите сделать безграничный мир.</p>
<p>Теперь создаем ландшафт - объект Terrain:</p>
<pre class="gml language-gml"><code class="hljs gml language-gml">terrain = TerrainCreate(<span class="hljs-symbol">global</span>.scene);
TerrainSetHeightData(terrain, hds);
TerrainSetTileSize(terrain, <span class="hljs-number">32</span>);
TerrainSetTilesPerTexture(terrain, <span class="hljs-number">8</span>);
TerrainSetQualityDistance(terrain, <span class="hljs-number">100</span>);
TerrainSetQualityStyle(terrain, hrsFullGeometry);
TerrainSetMaxCLodTriangles(terrain, <span class="hljs-number">10000</span>);
TerrainSetCLodPrecision(terrain, <span class="hljs-number">50</span>);
TerrainSetOcclusionFrameSkip(terrain, <span class="hljs-number">0</span>);
TerrainSetOcclusionTesselate(terrain, totTesselateIfVisible);
</code></pre>
<p>Если запустить игру на данном этапе, то ландшафт, скорее всего, будет слишком высоким и повернутым на 90 градусов. Это нетрудно исправить, установив желаемый масштаб по оси Z и повернув объект по оси X: </p>
<pre class="gml language-gml"><code class="hljs gml language-gml">ObjectSetScale(terrain, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.1</span>);
ObjectRotate(terrain, <span class="hljs-number">90</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
</code></pre>
<p>Отдельного слова заслуживает наложение текстуры на ландшафт. Это можно сделать разными способами, я же предлагаю следующий: первая текстура материала (диффузная) будет натянута на весь ландшафт, а вторая (текстура детализации) будет многократно повторяться с необходимым масштабом, накладываясь на первую в режиме modulate (то есть, изменяя яркость предыдущей). Таким образом, возникнет иллюзия того, что ландшафт использует огромную детализированную текстуру. </p>
<pre class="gml language-gml"><code class="hljs gml language-gml">MaterialCreate(<span class="hljs-string">&quot;mTerrain&quot;</span>, <span class="hljs-string">&quot;terrain-diffuse.jpg&quot;</span>);
MaterialSetOptions(<span class="hljs-string">&quot;mTerrain&quot;</span>, <span class="hljs-symbol">false</span>, <span class="hljs-symbol">true</span>);
MaterialCreate(<span class="hljs-string">&quot;detmap&quot;</span>, <span class="hljs-string">&quot;terrain-detail.jpg&quot;</span>);
MaterialSetTextureScale(<span class="hljs-string">&quot;detmap&quot;</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
MaterialSetSecondTexture(<span class="hljs-string">&quot;mTerrain&quot;</span>, <span class="hljs-string">&quot;detmap&quot;</span>);
ObjectSetMaterial(terrain, <span class="hljs-string">&quot;mTerrain&quot;</span>);
</code></pre>
<p>Обратите внимание, что мы отключаем освещение для материала ландшафта - дело в том, что динамический LOD не позволяет задавать нормали для вершин (поскольку наборы вершин постоянно меняются), что необходимо для корректного освещения полигонов. Поэтому для ландшафта следует использовать статическое освещение - карту освещенности, объединенную с диффузной текстурой.</p>
<p>Осталась еще одна задача: перемещение персонажа по ландшафту. Это нетрудно сделать при помощи специально предусмотренной функции - <code>TerrainGetHeightAtObjectPosition</code>, которая возвращает высоту земли в точке, совпадающей с абсолютной позицией объекта:</p>
<pre class="gml language-gml"><code class="hljs gml language-gml">ObjectSetPositionY(camPos, TerrainGetHeightAtObjectPosition(terrain, camPos) + <span class="hljs-number">1</span>);
</code></pre>
</body>
</html>
