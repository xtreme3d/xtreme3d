<!DOCTYPE html>
<html lang="ru">
<head>
    <title>ShadowMap</title>
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
    <meta charset="windows-1251">
    <meta name="author" content="Gecko">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="text/css" href="../sakura.css" inline>
    <link rel="stylesheet" type="text/css" href="../github.css" inline>
</head>
<body>
<h1 id="shadowmap">ShadowMap</h1>
<p>На современных видеокартах есть возможность рендерить динамические тени при помощи метода теневых карт (shadow mapping). В основе этого метода лежит идея о том, что освещенные точки - это те точки, которые видны из положения источника света. "Видимость" в данном случае означает, что данная точка успешно проходит тест глубины при рендеринге из положения источника света. Таким образом, shadow mapping работает в два прохода: сначала делается рендеринг из положения источника света - значения глубины записываются в специальный буфер. Затем делается обычный рендеринг, во время которого полученный буфер используется для проверки, попадает ли тот или иной пиксель в тень (эта проверка осуществляется во фрагментном GLSL-шейдере).</p>
<p>Теневые карты очень эффективны - они работают намного быстрее, чем <a href="shadowvolume.html">ShadowVolume</a>. Но они имеют и недостаток - артефакты дискретизации: иными словами, если не использовать гигантский буфер глубины, то тени получаются сильно пикселизированные. Впрочем, этот эффект можно свести на нет, если во фрагметном шейдере отфильтровать выборку из буфера глубины ядром 3х3 или 4х4 - в результате чего получаются мягкие тени без пикселизации. Данное расширение метода теневых карт получило название PCF (Percentage Closer Filtering).</p>
<p>Следует также помнить, что теневая карта имеет ограниченную область покрытия, которая зависит от размера проекции. Чем больше проекция, тем больше объектов вокруг источника света будут отбрасывать тени, но вместе с тем будет повышаться пикселизация теней. Для того, чтобы покрывать тенями большие территории, используется метод каскадных теневых карт (Cascaded Shadow Maps, CSM). При использовании CSM рендерится несколько теневых карт вместо одной, с разными размерами проекции, и затем выборка из них интерполируется в зависимости от координат текущего пикселя. В результате охват сцены тенями возрастает в разы: получаются качественные тени вблизи от камеры и пикселизированные - вдалеке.</p>
<p>Xtreme3D не включает встроенную поддержку CSM, но его несложно реализовать самостоятельно, создав несколько объектов ShadowMap с разными размерами проекции.</p>
<p>Теневые карты требуют поддержки OpenGL 1.4 или выше, а также расширения <code>GL_ARB_framebuffer_object</code>. Для рендеринга теней на объектах нужна поддержка GLSL.</p>
<p>При работе с теневыми картами важно знать некоторые принципы их работы. Самая важная концепция - это пространство отсечения (clip space). В данном случае оно представляет собой прямоугольную трубу, ограниченную размером ортогональной проекции, а также ближней и дальней плоскостями отсечения. Условно говоря, через эту трубу источник света "видит" освещенные точки. Для создания этой "трубы" используется объект ShadowCamera - теневая камера. Именно в этом пространстве происходит проверка, виден ли тот или иной пиксель - если он перекрывается более близким к источнику света пикселем, то, значит, он находится в тени. Чтобы осуществить эту проверку, нужно в вершинном шейдере перевести координаты вершины в пространство отсечения источника света - для этого используется специальная матрица, которую Xtreme3D вычисляет за вас. Ее остается только передать в шейдер функцией <code>GLSLShaderSetParameterShadowMatrix</code>. Сам же буфер глубины передается функцией <code>GLSLShaderSetParameterShadowTexture</code>.</p>
<p>Вам необязательно писать собственный GLSL-шейдер для отрисовки теней - в Xtreme3D есть встроенный шейдер рельефа (BumpShader), который поддерживает тени. Просто передайте ему теневую карту функцией <code>BumpShaderSetShadowMap</code> и наслаждайтесь результатом!</p>
<hr />
<h2 id="shadowmapcreate">ShadowMapCreate</h2>
<p><code>real ShadowMapCreate(real fbo, real viewer, real shadowCamera);</code></p>
<p>Создает теневую карту и возвращает указатель на нее.</p>
<ul>
<li><code>fbo</code> - указатель на FBO для рендеринга теневой карты</li>
<li><code>viewer</code> - указатель на вид, который используется для рендеринга теневой карты. Этот параметр нужен, по сути, только для доступа к контексту OpenGL, который соответствует данному виду</li>
<li><code>shadowCamera</code> - указатель на теневую камеру.</li>
</ul>
<hr />
<h2 id="shadowmapupdate">ShadowMapUpdate</h2>
<p><code>real ShadowMapUpdate(real shadowMap);</code></p>
<hr />
<h2 id="shadowmapsetcamera">ShadowMapSetCamera</h2>
<p><code>real ShadowMapSetCamera(real shadowmap, real shadowCamera);</code></p>
<p>Задает камеру теневой карты. Эта камера используется для рендеринга теней - куда смотрит камера, в ту сторону и направлены световые лучи.</p>
<ul>
<li><code>shadowmap</code> - указатель на теневую карту</li>
<li><code>camera</code> - указатель на теневую камеру.</li>
</ul>
<hr />
<h2 id="shadowmapsetviewer">ShadowMapSetViewer</h2>
<p><code>real ShadowMapSetViewer(real shadowmap, real viewer);</code></p>
<p>Задает вид, который используется для рендеринга теневой карты.</p>
<ul>
<li><code>fbo</code> - указатель на FBO для рендеринга теневой карты</li>
<li><code>viewer</code> - указатель на вид.</li>
</ul>
<hr />
<h2 id="shadowmapsetfbo">ShadowMapSetFBO</h2>
<p><code>real ShadowMapSetFBO(real shadowmap, real fbo);</code></p>
<p>Задает FBO для рендеринга теней.</p>
<ul>
<li><code>shadowmap</code> - указатель на теневую карту</li>
<li><code>fbo</code> - указатель на FBO.</li>
</ul>
<hr />
<h2 id="shadowcameracreate">ShadowCameraCreate</h2>
<p><code>real ShadowCameraCreate(real parent);</code></p>
<p>Создает теневую камеру и возвращает указатель на нее. Теневая камера используется объектом ShadowMap для формирования теневой проекции. Тени будут рендериться внутри объема, соответствующего ортогональной проекции теневой камеры. Этот объем ограничен размером и плоскостями отсечения - см. функции ниже.</p>
<ul>
<li><code>parent</code> - указатель на родителя.</li>
</ul>
<hr />
<h2 id="shadowcamerasetprojectionsize">ShadowCameraSetProjectionSize</h2>
<p><code>real ShadowCameraSetProjectionSize(real shadowCamera, real size);</code></p>
<p>Задает полуразмер ортогональной проекции теневой камеры. Этот параметр влияет на площадь, которая охватывается тенями - все объекты за пределами этой площади не будут отбрасывать тень. Центр проекции соответствует позиции камеры. Если в вашей игре персонаж перемещается по широкому пространству, то стоит двигать теневую камеру вместе с персонажем, чтобы невозможно было дойти до края теневой карты.</p>
<ul>
<li><code>shadowCamera</code> - указатель на теневую камеру</li>
<li><code>size</code> - полуразмер проекции. Слишком низкие значения приведут к небольшому охвату теневой карты, слишком высокие - к заметному уменьшению детализации теней. Значение по умолчанию 5.</li>
</ul>
<hr />
<h2 id="shadowcamerasetzclippingplanes">ShadowCameraSetZClippingPlanes</h2>
<p><code>real ShadowCameraSetZClippingPlanes(real sc, real znear, real zfar);</code></p>
<p>Задает ближнюю и дальнюю плоскости отсечения теневой камеры. Все, что не попадает в этот диапазон в пространстве отсечения теневого буфера, не будет отбрасывать тень.</p>
<ul>
<li><code>shadowCamera</code> - указатель на теневую камеру</li>
<li><code>znear</code> - расстояние до ближней плоскости отсечения (допустимы отрицательные значения). Значение по умолчанию -100.</li>
<li><code>zfar</code> - расстояние до дальней плоскости отсечения. Значение по умолчанию 100.</li>
</ul>
</body>
</html>
