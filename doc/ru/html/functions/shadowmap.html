<HTML>
<HEAD>
<META http-equiv=Content-Type content="text/html; charset=windows-1251">
<TITLE>ShadowMap</TITLE>
<LINK href="../data/style.css" type=text/css rel=stylesheet>
</HEAD>
<BODY>

<DIV ALIGN=justify>

<H1 class=pagetitle>ShadowMap</H1>

<A class=type>Класс: TGLShadowMap</A><BR><BR>

<A>На современных видеокартах есть возможность рендерить динамические тени при помощи метода теневых карт (shadow mapping). Он работает только с направленным светом. В основе этого метода лежит идея о том, что освещенные точки - это те точки, которые видны из положения источника света. "Видимость" в данном случае означает, что данная точка успешно проходит тест глубины при рендеринге из положения источника света. Таким образом, shadow mapping работает в два прохода: сначала делается рендеринг из положения источника света - значения глубины записываются в специальный буфер. Затем делается обычный рендеринг, во время которого полученный буфер используется для проверки, попадает ли тот или иной пиксель в тень (эта проверка осуществляется во фрагментном GLSL-шейдере).
<BR>Теневые карты очень эффективны - они работают намного быстрее, чем ShadowVolume. Но они имеют и недостаток - артефакты дискретизации: иными словами, если не использовать гигантский буфер глубины, то тени получаются сильно пикселизированные. Впрочем, этот эффект можно свести на нет, если во фрагметном шейдере отфильтровать выборку из буфера глубины ядром 3х3 или 4х4 - в результате чего получаются мягкие тени без пикселизации. Данное расширение метода теневых карт получило название PCF (Percentage Closer Filtering). 
<BR>Теневые карты также страдают от ряда других артефактов, известных как shadow acne и peter panning, но с ними достаточно просто бороться. Shadow acne - это характерный муаровый узор, который возникает на некоторых гранях, принимающих тени, когда значения глубины на карте совпадают со значения глубины граней. С этим эффектом обычно борятся при помощи небольшого смещения теневых координат по оси Z. Однако слишком сильное смещение может привести к эффекту, названному в честь Питера Пэна - тень может "открепиться" от грани, и будет казаться, что объект парит в воздухе.
<BR>
<BR>Следует помнить, что теневая карта имеет ограниченную область покрытия, которая зависит от размера проекции. Чем больше проекция, тем больше объектов вокруг источника света будут отбрасывать тени, но вместе с тем будет повышаться пикселизация теней. Для того, чтобы покрывать тенями большие территории, используется метод каскадных теневых карт (Cascaded Shadow Maps, CSM). При использовании CSM рендерится несколько теневых карт вместо одной, с разными размерами проекции, и затем выборка из них интерполируется в зависимости от координат текущего пикселя. В результате охват сцены тенями возрастает в разы: получаются качественные тени вблизи от камеры и пикселизированные - вдалеке. 
<BR>Xtreme3D не включает встроенную поддержку CSM, но его несложно реализовать самостоятельно, создав несколько объектов ShadowMap с разными размерами проекции.
<BR>
<BR>Теневые карты требуют поддержки OpenGL 1.4 или выше, а также расширения GL_ARB_framebuffer_object. Для рендеринга теней на объектах нужна поддержка GLSL.
<BR>
<BR>При работе с теневыми картами важно знать некоторые принципы их работы. Самая важная концепция - это пространство отсечения (clip space). В данном случае оно представляет собой прямоугольную трубу, ограниченную размером ортогональной проекции, а также ближней и дальней плоскостями отсечения. Условно говоря, через эту трубу источник света "видит" освещенные точки. И именно в этом пространстве происходит проверка, виден ли тот или иной пиксель - если он перекрывается более близким к источнику света пикселем, то, значит, он находится в тени. Чтобы осуществить эту проверку, нужно в вершинном шейдере перевести координаты вершины в пространство отсечения источника света - для этого используется специальная матрица, которую Xtreme3D вычисляет за вас. Ее остается только передать в шейдер функцией 
</A><A class=funclink href=../functions/shader.htm#GLSLShaderSetParameterShadowMatrix>GLSLShaderSetParameterShadowMatrix</A><A>. 
Сам же буфер глубины передается функцией 
</A><A class=funclink href=../functions/shader.htm#GLSLShaderSetParameterShadowTexture>GLSLShaderSetParameterShadowTexture</A><A>.
<BR>
<BR>Вам необязательно писать собственный GLSL-шейдер для отрисовки теней - в Xtreme3D есть встроенный шейдер рельефа (BumpShader), который поддерживает тени. Просто передайте ему теневую карту функцией 
</A><A class=funclink href=../functions/shader.htm#BumpShaderSetShadowMap>BumpShaderSetShadowMap</A><A> 
и наслаждайтесь результатом!</A><A>
</A>
<HR>

<A name="ShadowMapCreate"></A>
<H1 class=name>ShadowMapCreate</H1>
<A class=type>real</A><A> = </A><A class=function>ShadowMapCreate</A><A>( res,viewer,caster as </A><A class=type>real</A><A> );</A>
<BR><A>Создает теневую карту и возвращает ее id.</A>
<BR><A>res - разрешение z-буфера теневой карты. Обычно используются степени двойки: 256, 512, 1024</A>
<BR><A>viewer - вид, который используется для рендеринга теневой карты. Этот параметр нужен, по сути, только для доступа к контексту OpenGL, который соответствует данному виду</A>
<BR><A>caster - объект, который должен отбрасывать тень. Рекурсивно учитываются также и все потомки данного объекта.</A>
<HR>

<A name="ShadowMapSetCamera"></A>
<H1 class=name>ShadowMapSetCamera</H1>
<A class=type>real</A><A> = </A><A class=function>ShadowMapSetCamera</A><A>( shadowmap,camera as </A><A class=type>real</A><A> );</A>
<BR><A>Задает камеру теневой карты. Эта камера используется для рендеринга теней - куда смотрит камера, в ту сторону и направлены световые лучи. Все остальные свойства камеры игнорируются.</A>
<BR><A>shadowmap - id теневой карты</A>
<BR><A>camera - id камеры.</A>
<HR>

<A name="ShadowMapSetCaster"></A>
<H1 class=name>ShadowMapSetCaster</H1>
<A class=type>real</A><A> = </A><A class=function>ShadowMapSetCaster</A><A>( shadowmap,caster as </A><A class=type>real</A><A> );</A>
<BR><A>Задает объект, который должен отбрасывать тень.</A>
<BR><A>shadowmap - id теневой карты</A>
<BR><A>caster - id объекта.</A>
<HR>

<A name="ShadowMapSetProjectionSize"></A>
<H1 class=name>ShadowMapSetProjectionSize</H1>
<A class=type>real</A><A> = </A><A class=function>ShadowMapSetProjectionSize</A><A>( shadowmap,size as </A><A class=type>real</A><A> );</A>
<BR><A>Задает полуразмер ортогональной проекции, которая используется для рендеринга теней. Этот параметр влияет на площадь, которая охватывается теневой картой - все объекты за пределами этой площади не будут отбрасывать тень. Центр проекции соответствует позиции камеры, которая задается функцией </A><A class=funclink href=../functions/shadowmap.htm#ShadowMapSetCamera>ShadowMapSetCamera</A><A>. Если в вашей игре персонаж перемещается по широкому пространству, то стоит двигать эту камеру вместе с персонажем, чтобы невозможно было дойти до края теневой карты.</A>
<BR><A>shadowmap - id теневой карты</A>
<BR><A>size - полуразмер проекции. Слишком низкие значения приведут к небольшому охвату теневой карты, слишком высокие - к заметному уменьшению детализации теней. Значение по умолчанию - 20.</A>
<HR>

<A name="ShadowMapSetZScale"></A>
<H1 class=name>ShadowMapSetZScale</H1>
<A class=type>real</A><A> = </A><A class=function>ShadowMapSetZScale</A><A>( shadowmap,zscale as </A><A class=type>real</A><A> );</A>
<BR><A>Задает коэффициент масштабирования теневой матрицы по оси Z в пространстве отсечения. Регулируя этот параметр, можно уменьшить артефакты, вызванные недостаточной точностью z-буфера - shadow acne и peter panning.</A>
<BR><A>shadowmap - id теневой карты</A>
<BR><A>zscale - коэффициент масштабирования. Значение по умолчанию - 1.</A>
<HR>

<A name="ShadowMapSetZClippingPlanes"></A>
<H1 class=name>ShadowMapSetZClippingPlanes</H1>
<A class=type>real</A><A> = </A><A class=function>ShadowMapSetZClippingPlanes</A><A>( shadowmap,znear,zfar as </A><A class=type>real</A><A> );</A>
<BR><A>Задает ближнюю и дальнюю плоскости отсечения. Все, что не попадает в этот диапазон в пространстве отсечения теневого буфера, не будет отбрасывать тень.</A>
<BR><A>shadowmap - id теневой карты</A>
<BR><A>znear - расстояние до ближней плоскости отсечения (допустимы отрицательные значения). Значение по умолчанию - 0</A>
<BR><A>znear - расстояние до дальней плоскости отсечения. Значение по умолчанию - 100.</A>
<HR>

<A name="ShadowMapSetFBO"></A>
<H1 class=name>ShadowMapSetFBO</H1>
<A class=type>real</A><A> = </A><A class=function>ShadowMapSetFBO</A><A>( shadowmap,fbo as </A><A class=type>real</A><A> );</A>
<BR><A>Задает фреймбуферный объект (FBO) для рендеринга теней. По умолчанию теневая карта рендерит в свой собственный внутренний буфер, но в некоторых случаях вам может понадобиться внешний - например, для реализации теней методом VSM. Обратите внимание, что перед рендерингом буфер очищается белым цветом.</A>
<BR><A>shadowmap - id теневой карты</A>
<BR><A>fbo - id FBO.</A>
<HR>

<A name="ShadowMapRender"></A>
<H1 class=name>ShadowMapRender</H1>
<A class=type>real</A><A> = </A><A class=function>ShadowMapRender</A><A>( shadowmap as </A><A class=type>real</A><A> );</A>
<BR><A>Осуществляет рендеринг в буфер теневой карты.</A>
<BR><A>shadowmap - id теневой карты.</A>
<HR>

</DIV>

</BODY>
</HTML>
